#!/usr/bin/env sh

set -ex

# WORKING SCRIPTS BELOW
if [ -z "$1" ]; then
  echo "Please provide a target: 'node' or 'web'"
  exit 1
fi

# Build for Node
if [ "$1" == node ]; then
  bin/rbwasm build --ruby-version 3.3 -o .wasm/ruby.wasm
  bin/rbwasm pack .wasm/ruby.wasm \
    --dir ./app::/app \
    --dir ./config::/config \
    --dir ./db::/db \
    --dir ./vendor::/vendor \
    --dir ./public::/public \
    --dir ./lib::/lib \
    -o .wasm/rails.wasm
  wasmtime run .wasm/rails.wasm -e "$(cat .wasm/test.rb)"
fi

if [ "$1" == web ]; then
  JS=true bin/rbwasm build --ruby-version 3.3 -o .wasm/ruby-web.wasm
  bin/rbwasm pack .wasm/ruby-web.wasm \
    --dir ./app::/app \
    --dir ./config::/config \
    --dir ./db::/db \
    --dir ./vendor::/vendor \
    --dir ./public::/public \
    --dir ./lib::/lib \
    -o .wasm/rails-web.wasm
fi
